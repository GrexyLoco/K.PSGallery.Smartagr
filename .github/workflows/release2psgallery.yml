name: ðŸš€ Smart PowerShell Module Release Pipeline

# ðŸŽ¯ Triggers: Push to master branch (e.g., PR merge)
# ðŸ“‹ Required Repository Variables:
# - UBUNTU_VERSION: Ubuntu runner version (e.g., "ubuntu-22.04")
# - MODULE_NAME: PowerShell module name for dispatch
# - TARGET_REPOSITORY: Target repository for auto-publish dispatch
# ðŸ“‹ Required Repository Secrets:
# - REPO_DISPATCH_TOKEN: Personal Access Token for cross-repo dispatch

on:
  push:
    branches: [master, main]
  workflow_dispatch:
    # Optional manual trigger for testing
    inputs:
      test:
        description: "Run validation only (no dispatch)"
        required: false
        default: false
        type: boolean

env:
  # ðŸŒ Global environment variables for consistency
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  # ðŸ“¦ Module Configuration (can be overridden by repository variables)
  MODULE_NAME: ${{ vars.MODULE_NAME || 'K.PSGallery.SmartAgr' }}
  TARGET_REPOSITORY: ${{ vars.TARGET_REPOSITORY || 'GrexyLoco/K.PSGallery' }}

jobs:
  quality-gate:
    name: ðŸ” Quality Gate
    runs-on: ${{ vars.UBUNTU_VERSION || 'ubuntu-22.04' }}
    outputs:
      test-success: ${{ steps.validation.outputs.test-success }}
      total-tests: ${{ steps.validation.outputs.total-tests }}
      passed-tests: ${{ steps.validation.outputs.passed-tests }}
      failed-tests: ${{ steps.validation.outputs.failed-tests }}
      skipped-tests: ${{ steps.validation.outputs.skipped-tests }}
      test-duration: ${{ steps.validation.outputs.test-duration }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ” Validate PowerShell Module
        id: validation
        uses: GrexyLoco/K.Actions.PSModuleValidation@v1.0.1
        with:
          test-path: "./Tests"
          output-path: "./TestResults.xml"
          validate-all-codebase: "false"
          github-token: ${{ secrets.GITHUB_TOKEN }}
          module-name: ${{ env.MODULE_NAME }}

  version-and-tag:
    name: ðŸ“¦ Version & Tag
    runs-on: ubuntu-latest
    needs: quality-gate
    if: needs.quality-gate.outputs.test-success == 'true'
    outputs:
      new-version: ${{ steps.version.outputs.newVersion }}
      current-version: ${{ steps.version.outputs.currentVersion }}
      bump-type: ${{ steps.version.outputs.bumpType }}
      last-release-tag: ${{ steps.version.outputs.lastReleaseTag }}
    permissions:
      contents: write
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ”¢ Calculate next version
        id: version
        uses: GrexyLoco/K.Actions.NextVersion@v1
        with:
          manifestPath: './K.PSGallery.Smartagr.psd1'
          branchName: ${{ github.ref_name }}
          targetBranch: 'master'

      - name: ðŸ·ï¸ Create Git Tag
        if: steps.version.outputs.newVersion != ''
        run: |
          git config user.name "${{ env.RELEASE_AUTHOR }}"
          git config user.email "${{ env.RELEASE_EMAIL }}"
          git tag -a "v${{ steps.version.outputs.newVersion }}" -m "Release v${{ steps.version.outputs.newVersion }}"
          git push origin "v${{ steps.version.outputs.newVersion }}"

      - name: ðŸ“ Release Summary
        if: always()
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸ“¦ Version Calculation

          **Current Version:** `${{ steps.version.outputs.currentVersion }}`
          **New Version:** `${{ steps.version.outputs.newVersion }}`
          **Bump Type:** `${{ steps.version.outputs.bumpType }}`
          **Last Release Tag:** `${{ steps.version.outputs.lastReleaseTag }}`

          ---
          EOF

  trigger-publish:
    name: ðŸš€ Trigger Publish via Repo Dispatch (K.PSGallery)
    runs-on: ubuntu-latest
    needs: [quality-gate, version-and-tag]
    if: needs.quality-gate.outputs.test-success == 'true' && needs.version-and-tag.outputs.new-version != ''
    steps:
      - name: ðŸ“¤ Dispatch to auto-publish workflow
        uses: peter-evans/repository-dispatch@v4
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: ${{ env.TARGET_REPOSITORY }}
          event-type: publish-module
          client-payload: |
            {
              "repo": "${{ github.repository }}",
              "tag": "v${{ needs.version-and-tag.outputs.new-version }}",
              "bump_type": "${{ needs.version-and-tag.outputs.bump-type }}",
              "triggered_by": "${{ github.actor }}",
              "source_url": "https://github.com/${{ github.repository }}",
              "gallery_url": "https://www.powershellgallery.com/packages/${{ env.MODULE_NAME }}/${{ needs.version-and-tag.outputs.new-version }}"
            }

      - name: ðŸ“ Dispatch Summary
        if: always()
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Auto-Publish Pipeline Triggered

          **Module:** `${{ env.MODULE_NAME }}`
          **Target Repository:** `${{ env.TARGET_REPOSITORY }}`
          **Source Repository:** `${{ github.repository }}`
          **Branch:** `${{ github.ref_name }}`
          **Status:** âœ… Dispatch sent successfully

          The auto-publish pipeline will now handle:
          - ðŸ”¢ Semantic version calculation
          - ðŸ“¦ Module packaging
          - ðŸš€ PowerShell Gallery publishing
          - ðŸ·ï¸ GitHub release creation

          ---
          EOF
