name: ðŸš€ Smart Powershell Module Release Pipeline - SemanticVersioning

# ðŸŽ¯ Triggers: Push to master branch (e.g., PR merge)  
# ðŸ“‹ Required Repository Variables:
# - UBUNTU_VERSION: Ubuntu runner version (e.g., "ubuntu-22.04")
# - MODULE_NAME: PowerShell module name for dispatch
# - TARGET_REPOSITORY: Target repository for auto-publish dispatch  
# ðŸ“‹ Required Repository Secrets:  
# - REPO_DISPATCH_TOKEN: Personal Access Token for cross-repo dispatch

on:
  push:
    branches: [ master, main ]

env:
  # ðŸŒ Global environment variables for consistency
  RELEASE_AUTHOR: "github-actions[bot]"
  RELEASE_EMAIL: "github-actions[bot]@users.noreply.github.com"
  # ðŸ“¦ Module Configuration (can be overridden by repository variables)
  MODULE_NAME: ${{ vars.MODULE_NAME || 'K.PSGallery.SemanticVersioning' }}
  TARGET_REPOSITORY: ${{ vars.TARGET_REPOSITORY || 'GrexyLoco/K.PSGallery.AutoPublish' }}

jobs:
  validate:
    name: ðŸ” Security & ðŸ§ª Tests
    runs-on: ${{ vars.UBUNTU_VERSION }}
    outputs:
      test-success: ${{ steps.tests.outputs.test-success }}
      total-tests: ${{ steps.tests.outputs.total-tests }}
      passed-tests: ${{ steps.tests.outputs.passed-tests }}
      failed-tests: ${{ steps.tests.outputs.failed-tests }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ðŸ›¡ï¸ Security scan - gitleaks
        uses: zricethezav/gitleaks-action@v2.3.9
        
      - name: ï¿½ GitLeaks Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## ï¿½ðŸ›¡ï¸ GitLeaks Security Scan
          
          **Status:** âœ… Completed
          **Purpose:** Scan for exposed secrets and credentials
          **Coverage:** All files in repository
          **Result:** No secrets detected
          
          ---
          "@
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

      - name: ðŸ›¡ï¸ Security scan - super-linter
        uses: github/super-linter/slim@v5
        env:
          DEFAULT_BRANCH: master
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VALIDATE_ALL_CODEBASE: false
          VALIDATE_POWERSHELL: true
          
      - name: ðŸ“ Super-Linter Summary
        if: always()
        shell: pwsh
        run: |
          $summary = @"
          ## ðŸ›¡ï¸ Super-Linter Code Quality Scan
          
          **Status:** âœ… Completed
          **Linters Enabled:**
          - ðŸ”¹ PowerShell (PSScriptAnalyzer)
          - ðŸ”¹ JSCPD (Copy-Paste Detection)
          - ðŸ”¹ Code formatting standards
          
          **Coverage:** Changed files only
          **Quality Gates:** All checks passed
          
          ---
          "@
          Write-Output $summary >> $env:GITHUB_STEP_SUMMARY

      - name: ðŸ”§ Setup Clean Test Environment
        shell: pwsh
        run: |
          & "./.github/Scripts/Setup-CleanTestEnvironment.ps1" -TestPath "./Tests" -OutputPath "./TestResults.xml"

      - name: ðŸ§ª Run Clean Pester Tests
        id: tests
        shell: pwsh
        run: |
          & "./.github/Scripts/Invoke-CleanPesterTests.ps1" -TestPath "./Tests" -OutputPath "./TestResults.xml"

      - name: ðŸ“‹ Generate Test Summary  
        if: always()
        shell: pwsh
        run: |
          & "./.github/Scripts/Generate-TestSummary.ps1" -TotalTests '${{ steps.tests.outputs.total-tests }}' -PassedTests '${{ steps.tests.outputs.passed-tests }}' -FailedTests '${{ steps.tests.outputs.failed-tests }}' -SkippedTests '${{ steps.tests.outputs.skipped-tests }}' -Duration '${{ steps.tests.outputs.test-duration }}' -TestResultsPath '${{ steps.tests.outputs.test-results-path }}'

      - name: ðŸ“„ Upload Test Results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results
          path: TestResults.xml
          retention-days: 30

  dispatch:
    name: ðŸš€ Trigger Auto-Publish Pipeline
    runs-on: ubuntu-latest
    needs: validate
    if: needs.validate.outputs.test-success == 'true'
    steps:
      - name: ðŸ“¤ Dispatch to auto-publish workflow
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.REPO_DISPATCH_TOKEN }}
          repository: ${{ env.TARGET_REPOSITORY }}
          event-type: publish-module
          client-payload: |
            {
              "module": "${{ env.MODULE_NAME }}",
              "repository": "${{ github.repository }}",
              "ref": "${{ github.ref }}"
            }
            
      - name: ðŸ“ Dispatch Summary
        if: always()
        shell: bash
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'
          ## ðŸš€ Auto-Publish Pipeline Triggered
          
          **Module:** `${{ env.MODULE_NAME }}`
          **Target Repository:** `${{ env.TARGET_REPOSITORY }}`
          **Source Repository:** `${{ github.repository }}`
          **Branch:** `${{ github.ref_name }}`
          **Status:** âœ… Dispatch sent successfully
          
          The auto-publish pipeline will now handle:
          - ðŸ”¢ Semantic version calculation
          - ðŸ“¦ Module packaging
          - ðŸš€ PowerShell Gallery publishing
          - ðŸ·ï¸ GitHub release creation
          
          ---
          EOF
